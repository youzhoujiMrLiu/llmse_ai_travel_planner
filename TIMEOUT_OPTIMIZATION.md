# 超时配置优化说明

## 问题背景

AI 请求(调用通义千问 API 生成旅行计划)通常需要较长时间,原有的 10 秒超时限制导致请求经常失败。

## 超时配置优化

### 前端 (Frontend)

#### 1. `apiClient.ts` - 通用 API 客户端
```typescript
const apiClient = axios.create({
  baseURL: '/api',
  timeout: 60000, // 60秒 (从 10秒增加)
})
```

**调整原因**:
- ✅ AI 生成旅行计划通常需要 30-60 秒
- ✅ 包含复杂的 JSON 解析和数据处理
- ✅ 网络波动情况下需要更长缓冲时间

**影响范围**:
- AI 生成计划请求 (`/api/ai/generate-plan`)
- 旅行计划 CRUD 操作 (`/api/travel-plans/*`)

---

#### 2. `authApi.ts` - 认证 API 客户端
```typescript
const authApiClient = axios.create({
  baseURL: '/api',
  timeout: 30000, // 30秒 (从 10秒增加)
})
```

**调整原因**:
- ✅ 认证请求通常较快,但为避免网络慢导致失败,适当增加
- ✅ 保持与其他 API 一致的容错能力

**影响范围**:
- 用户资料相关请求

---

### 后端 (Backend)

#### 1. `AIService.java` - RestTemplate 超时配置
```java
public AIService(RestTemplateBuilder restTemplateBuilder) {
    this.restTemplate = restTemplateBuilder
            .setConnectTimeout(Duration.ofSeconds(10))   // 连接超时 10 秒
            .setReadTimeout(Duration.ofSeconds(120))     // 读取超时 120 秒
            .build();
}
```

**调整说明**:
- **连接超时 (Connect Timeout)**: 10 秒
  - 建立 TCP 连接到通义千问 API 的时间
  - 通常很快,10 秒足够
  
- **读取超时 (Read Timeout)**: 120 秒
  - 等待 AI 生成完整旅行计划的时间
  - **这是关键配置**,AI 生成可能需要 60-90 秒
  - 留有足够缓冲时间(120 秒)

**原有问题**:
- ❌ 使用 `new RestTemplate()` 没有超时配置
- ❌ 默认超时取决于底层 HTTP 客户端(可能无限等待或过短)

---

#### 2. `application.properties` - Tomcat 服务器超时
```properties
# Server configuration
server.port=8080
# 增加连接超时时间,适配 AI 生成等耗时操作(单位:毫秒)
server.tomcat.connection-timeout=180000

# 最大 HTTP POST 大小(AI 响应可能较大)
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB
```

**调整说明**:
- **Tomcat 连接超时**: 180,000ms (180 秒 = 3 分钟)
  - 确保整个 HTTP 请求-响应周期有足够时间完成
  - 涵盖: 前端请求 → Spring Boot 处理 → 调用通义千问 → 解析响应 → 返回前端
  
- **最大请求大小**: 10MB
  - AI 生成的 JSON 响应可能包含详细行程(多天、多活动)
  - 避免响应过大被截断

---

## 超时链路分析

### 完整请求链路及超时设置

```
用户浏览器
    ↓
[前端 Axios: 60 秒]
    ↓
Vite 开发代理 (无超时限制)
    ↓
[Tomcat 服务器: 180 秒]
    ↓
Spring Boot Controller
    ↓
AIService
    ↓
[RestTemplate: 连接 10 秒 + 读取 120 秒]
    ↓
通义千问 API (实际生成时间: 30-90 秒)
    ↓
[响应返回,逆向经过所有节点]
    ↓
用户浏览器收到结果
```

### 超时设置合理性验证

| 层级 | 超时配置 | 预期耗时 | 缓冲空间 | 合理性 |
|------|---------|---------|---------|--------|
| 前端 Axios | 60 秒 | 30-50 秒 | 10-30 秒 | ✅ 合理 |
| Tomcat 服务器 | 180 秒 | 40-100 秒 | 80-140 秒 | ✅ 充足 |
| RestTemplate 连接 | 10 秒 | 1-3 秒 | 7-9 秒 | ✅ 充足 |
| RestTemplate 读取 | 120 秒 | 30-90 秒 | 30-90 秒 | ✅ 充足 |

---

## 测试建议

### 1. 正常场景测试
- 输入标准旅行需求(如 5 天日本行程)
- 观察完整请求时间
- 预期: 30-60 秒内成功返回

### 2. 复杂场景测试
- 输入复杂需求(如 15 天多城市行程)
- AI 生成时间可能更长
- 预期: 60-90 秒内成功返回

### 3. 网络波动测试
- 在网络较慢环境下测试
- 确保不会因网络波动导致过早超时
- 预期: 即使网络慢,也能在超时内完成

### 4. 错误场景测试
- 输入无效 API Key
- 观察错误处理和超时行为
- 预期: 快速失败(不等到超时),返回明确错误信息

---

## 监控和优化

### 监控指标
1. **平均响应时间**: 记录 AI 生成请求的平均耗时
2. **超时频率**: 监控是否仍有超时发生
3. **成功率**: 计算 AI 请求成功率

### 进一步优化建议
1. **添加加载进度**:
   - 前端显示 "AI 正在生成中...预计 30-60 秒"
   - 添加进度条或动画,提升用户体验

2. **后端异步处理**:
   - 将 AI 生成改为异步任务
   - 立即返回任务 ID,前端轮询或 WebSocket 推送结果
   - 彻底解决超时问题

3. **缓存机制**:
   - 对相似请求(目的地、天数相近)缓存结果
   - 减少 AI API 调用次数和费用

4. **降级方案**:
   - AI 调用失败时,返回模板化行程
   - 用户可以在模板基础上修改

---

## 配置总结

| 配置项 | 原值 | 新值 | 提升 |
|--------|------|------|------|
| 前端 API 超时 | 10 秒 | 60 秒 | **6x** |
| 前端认证超时 | 10 秒 | 30 秒 | **3x** |
| 后端连接超时 | 无配置 | 10 秒 | 新增 ✅ |
| 后端读取超时 | 无配置 | 120 秒 | 新增 ✅ |
| Tomcat 超时 | 默认(20 秒) | 180 秒 | **9x** |

---

## 结论

通过优化前后端超时配置,确保 AI 生成旅行计划的完整链路有足够的时间完成:
- ✅ 前端 60 秒超时,覆盖大部分正常场景
- ✅ 后端 120 秒读取超时,充分满足 AI 生成时间
- ✅ Tomcat 180 秒连接超时,作为最后保障
- ✅ 各层级超时时间合理递增,避免中间环节过早断开

**建议**: 在生产环境中根据实际监控数据进一步微调超时时间。
